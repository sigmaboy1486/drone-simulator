<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drone Flight Simulator</title>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white">

<div class="container mx-auto p-4">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">

        <!-- CONTROLS -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">Flight Config</h2>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400">Angle</label>
                    <input type="range" id="angle" min="5" max="85" value="45" class="w-full">
                </div>

                <div>
                    <label class="text-xs text-gray-400">Velocity</label>
                    <input type="range" id="velocity" min="5" max="50" value="25" class="w-full">
                </div>

                <div>
                    <label class="text-xs text-gray-400">Yaw (Side)</label>
                    <input type="range" id="side_angle" min="0" max="90" value="30" class="w-full">
                </div>
            </div>

            <button id="playBtn"
                class="w-full mt-6 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-bold">
                â–¶ Launch Drone
            </button>
        </div>

        <!-- PLOT -->
        <div class="lg:col-span-3 bg-gray-800 rounded-xl border border-gray-700">
            <div id="plot" style="height:70vh;"></div>
        </div>

    </div>
</div>

<script>
let flightData = null;
let intervalId = null;

const SPEED_MS = 60;   // â±ï¸ lower = faster, higher = slower

/* FETCH DATA */
async function fetchData() {
    const res = await fetch("/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            angle: angle.value,
            velocity: velocity.value,
            gravity: 9.8,
            side_angle: side_angle.value,
            points: 300
        })
    });

    flightData = await res.json();
    drawInitialPlot();
}

/* INITIAL PLOT */
function drawInitialPlot() {
    const path = {
        x: flightData.x,
        y: flightData.y,
        z: flightData.z,
        type: "scatter3d",
        mode: "lines",
        line: { color: "#555", width: 2 }
    };

    const drone = {
        x: [flightData.x[0]],
        y: [flightData.y[0]],
        z: [flightData.z[0]],
        type: "scatter3d",
        mode: "markers",
        marker: { size: 8, color: "lime", symbol: "diamond" }
    };

    Plotly.newPlot("plot", [path, drone], {
        scene: {
            xaxis: { title: "X" },
            yaxis: { title: "Y" },
            zaxis: { title: "Z" },
            bgcolor: "#111827"
        },
        paper_bgcolor: "#111827",
        margin: { t: 0, b: 0, l: 0, r: 0 }
    });
}

/* ðŸš MANUAL ANIMATION (THIS ALWAYS WORKS) */
function animateDrone() {
    if (!flightData) return;

    let i = 0;
    clearInterval(intervalId);

    intervalId = setInterval(() => {
        if (i >= flightData.x.length) {
            clearInterval(intervalId);
            return;
        }

        Plotly.restyle("plot", {
            x: [[flightData.x[i]]],
            y: [[flightData.y[i]]],
            z: [[flightData.z[i]]]
        }, [1]);   // ðŸ‘ˆ update ONLY drone trace

        i++;
    }, SPEED_MS);
}

/* EVENTS */
playBtn.onclick = animateDrone;
document.querySelectorAll("input").forEach(el => el.oninput = fetchData);

/* INITIAL LOAD */
fetchData();
</script>

</body>
</html>
